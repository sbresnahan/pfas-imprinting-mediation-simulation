---
title: "Simulated Causal Analysis of PFAS Effects on Infant Neurodevelopment via Placental Imprinting"
author: "Sean T. Bresnahan"
date: "2025-07-25"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

This script simulates a causal mediation framework in which maternal PFAS exposure influences infant neurodevelopment (SRS scores) via changes in placental parent-of-origin isoform expression. The mediation pathway is moderated by fetal sex, and maternal DNA methylation is leveraged as a negative control to adjust for shared genetic and environmental confounding. I compare three methods: Control Outcome Calibration (COCA), Proximal g-Computation (PGC), and regression adjustment models that include the control outcome variable as a covariate as recommended by Huang (2021).

#### Dataset:

- 100 infants
- 100 isoforms (each with 1–5 CpG sites)
- Maternal PFAS exposure (log-normal)
- Fetal sex (binary)
- Latent shared confounder (correlated with PFAS)
- Isoform-level maternal expression ratios (simulating imprinting)
- Infant SRS scores (influenced by disrupted imprinting and confounder)
- PFAS affects imprinting of a subset of isoforms
- Some imprinting–SRS associations are confounded by maternal methylation

# Load Packages and Define Knitr Options

```{r data_setup, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(lavaan)
library(boot)
library(ggplot2)
library(knitr)
```

# Simulate Dataset

We first define the number of samples (infants) and isoforms to be simulated.

## Define Samples and Isoforms

```{r parameters}
set.seed(42)
n_samples <- 100
n_isoforms <- 100
```

Here we simulate fetal sex, maternal PFAS exposure levels, and a latent confounder that is correlated with PFAS.

## Generate Fetal Sex, PFAS Exposure, and Shared Confounder

```{r simulate_covariates}
# Fetal sex (0 = female, 1 = male)
fetal_sex <- rbinom(n_samples, size = 1, prob = 0.5)
hist(fetal_sex, main = "Fetal Sex", xlab = "Sex (0 = Female, 1 = Male)")

# Maternal PFAS exposure (ng/mL, log-normal)
PFAS <- rlnorm(n_samples, meanlog = log(3), sdlog = 0.4)
hist(PFAS, main = "PFAS Exposure", xlab = "ng/mL")

# Latent confounder U, correlated with PFAS
U <- rnorm(n_samples, mean = scale(PFAS), sd = 1)
```

Next, we simulate maternal DNA methylation data for each isoform, capturing shared environmental or genetic confounding via a latent variable.

## Simulate CpG Methylation from Shared Confounding Signal

```{r simulate_methylation}
n_cpg_per_isoform <- sample(1:5, size = n_isoforms, replace = TRUE)
maternal_meth_list <- lapply(n_cpg_per_isoform, function(n_cpg) {
  matrix(
    plogis(matrix(rnorm(n_samples * n_cpg, mean = rep(U, each = n_cpg), sd = 1), nrow = n_samples)),
    nrow = n_samples
  )
})
```

## Simulate Isoform-Level Expression Ratios

```{r simulate_expression_ratios}
# Start with baseline biallelic expression + noise (maternal expression ratio)
expr_ratios <- matrix(rnorm(n_samples * n_isoforms, mean = 0.5, sd = 0.03), nrow = n_samples)
hist(expr_ratios, main = "Baseline parental-origin expression ratios", xlab = "Ratio M:M+P")

# Define 50% of isoforms as true mediators
mediated_isoforms <- sample(1:n_isoforms, size = n_isoforms * 0.5)

# PFAS influences imprinting in these isoforms
for (i in mediated_isoforms) {
  expr_ratios[, i] <- expr_ratios[, i] + scale(PFAS) * rnorm(1, mean = 0.05, sd = 0.01)
}
hist(expr_ratios, main = "Parental-origin expression ratios with PFAS association", xlab = "Ratio M:M+P")
```

## Simulate SRS Scores Influenced by Disrupted Imprinting

```{r simulate_srs}
# Create SRS score from expression of mediated isoforms + confounder + noise
SRS_contrib <- rowSums(scale(expr_ratios[, mediated_isoforms]) %*%
                         matrix(rnorm(length(mediated_isoforms), mean = 2, sd = 0.5), ncol = 1))
SRS <- scale(SRS_contrib + scale(U) * 0.5 + rnorm(n_samples, 0, 1))
hist(SRS, main = "Simulated SRS", xlab = "SRS")
```

## Include Confounding Effects

```{r include_confounding}
# Select 50% of mediated isoforms to be confounded by methylation
confounded_idx <- sample(mediated_isoforms, size = length(mediated_isoforms) * 0.5)
confounding_contrib <- rep(0, n_samples)

for (i in confounded_idx) {
  meth_mean <- rowMeans(maternal_meth_list[[i]])
  expr_ratios[, i] <- expr_ratios[, i] + scale(meth_mean) * rnorm(1, mean = 0.2, sd = 0.05)
  confounding_contrib <- confounding_contrib + scale(meth_mean) * rnorm(1, mean = 1.5, sd = 0.3)
}

# Inject confounding into SRS
SRS <- scale(SRS + confounding_contrib)
hist(SRS, main = "Simulated SRS with methylation-driven bias", xlab = "SRS")
```

Finally, we clean up and scale the simulated matrices, then reshape the methylation data for downstream analysis and visualization.

## Finalize and Format Output

```{r finalize_output}
expr_df <- as.data.frame(expr_ratios)
colnames(expr_df) <- paste0("isoform_", 1:n_isoforms)

metadata_df <- data.frame(
  sample = 1:n_samples,
  SRS = SRS,
  PFAS = PFAS,
  fetal_sex = fetal_sex
)

meth_long <- do.call(rbind, lapply(1:n_isoforms, function(i) {
  meth_mat <- maternal_meth_list[[i]]
  n_cpg <- ncol(meth_mat)
  data.frame(
    sample = rep(1:n_samples, times = n_cpg),
    isoform = paste0("isoform_", i),
    cpg = rep(1:n_cpg, each = n_samples),
    meth = as.vector(meth_mat)
  )
}))

hist(meth_long$meth, main = "Isoform-Level Methylation", xlab = "Beta-value")
```

# Moderated Mediation Analysis (lavaan)

Select one isoform for demonstration.

```{r moderated_mediation}
iso <- "isoform_27"
df <- cbind(metadata_df, expr = expr_df[[iso]])

meth_avg <- meth_long %>%
  filter(isoform == iso) %>%
  group_by(sample) %>%
  summarise(m_meth = mean(meth), .groups = "drop")

df <- merge(df, meth_avg, by = "sample")

model <- '
  expr ~ a1*PFAS + a2*fetal_sex + a3*PFAS:fetal_sex
  SRS ~ b1*expr + b2*fetal_sex + b3*expr:fetal_sex + c*PFAS
  ind_female := a1 * b1
  ind_male := (a1 + a3) * (b1 + b3)
  dir := c
  total_female := dir + ind_female
  total_male := dir + ind_male
'

fit <- sem(model, data = df, se = "bootstrap", bootstrap = 100)
summary(fit, standardized = TRUE, fit.measures = TRUE)
```

# COCA (Control Outcome Calibration)

```{r coca}
coca_model <- lm(m_meth ~ PFAS + SRS, data = df)
beta_A <- coef(coca_model)["PFAS"]
beta_Y <- coef(coca_model)["SRS"]
psi_coca <- -beta_A / beta_Y
cat("COCA-calibrated PFAS effect estimate:", round(psi_coca, 4), "\n")

coca_fn <- function(data, indices) {
  d <- data[indices, ]
  fit <- lm(m_meth ~ PFAS + SRS, data = d)
  -coef(fit)["PFAS"] / coef(fit)["SRS"]
}

boot_out <- boot(df, coca_fn, R = 100)
boot.ci(boot_out, type = "perc")
```

# Proximal G-Computation (PGC)

```{r pgc}
bridge_model <- lm(m_meth ~ expr + SRS, data = df)
df$Z_hat <- predict(bridge_model)

df$Y_adj <- df$SRS - (df$Z_hat - mean(df$Z_hat))

pgc_model <- lm(Y_adj ~ PFAS + fetal_sex, data = df)
summary(pgc_model)

pgc_fn <- function(data, indices) {
  d <- data[indices, ]
  bridge <- lm(m_meth ~ expr + SRS, data = d)
  Z_hat <- predict(bridge)
  Y_adj <- d$SRS - (Z_hat - mean(Z_hat))
  pgc_fit <- lm(Y_adj ~ PFAS + fetal_sex, data = cbind(d, Y_adj))
  return(coef(pgc_fit)["PFAS"])
}

boot_out <- boot(df, pgc_fn, R = 100)
boot.ci(boot_out, type = "perc")
```

# Parallelized Analysis Across Isoforms

```{r parallelized_analysis, warning=F}
results_list <- vector("list", length = n_isoforms)
names(results_list) <- paste0("isoform_", 1:n_isoforms)

n_boot <- 10

for (i in 1:n_isoforms) {
  iso_name <- paste0("isoform_", i)
  
  df <- cbind(metadata_df, expr = expr_df[[iso_name]])
  meth_avg <- meth_long %>%
    filter(isoform == iso_name) %>%
    group_by(sample) %>%
    summarise(m_meth = mean(meth), .groups = "drop")
  df <- merge(df, meth_avg, by = "sample")

  model <- '
    expr ~ a1*PFAS + a2*fetal_sex + a3*PFAS:fetal_sex
    SRS ~ b1*expr + b2*fetal_sex + b3*expr:fetal_sex + c*PFAS
    ind_female := a1 * b1
    ind_male := (a1 + a3) * (b1 + b3)
    dir := c
    total_female := dir + ind_female
    total_male := dir + ind_male
  '
  
  lavaan_fit <- tryCatch({
    sem(model, data = df, se = "bootstrap", bootstrap = n_boot)
  }, error = function(e) NULL)

  coca_model <- lm(m_meth ~ PFAS + SRS, data = df)
  beta_A <- coef(coca_model)["PFAS"]
  beta_Y <- coef(coca_model)["SRS"]
  psi_coca <- -beta_A / beta_Y

  coca_fn <- function(data, indices) {
    d <- data[indices, ]
    fit <- lm(m_meth ~ PFAS + SRS, data = d)
    -coef(fit)["PFAS"] / coef(fit)["SRS"]
  }
  coca_boot <- boot(df, coca_fn, R = n_boot)
  coca_ci <- tryCatch(boot.ci(coca_boot, type = "perc"), error = function(e) NULL)

  bridge_model <- lm(m_meth ~ expr + SRS, data = df)
  df$Z_hat <- predict(bridge_model)
  df$Y_adj <- df$SRS - (df$Z_hat - mean(df$Z_hat))

  pgc_model <- lm(Y_adj ~ PFAS + fetal_sex, data = df)

  pgc_fn <- function(data, indices) {
    d <- data[indices, ]
    bridge <- lm(m_meth ~ expr + SRS, data = d)
    Z_hat <- predict(bridge)
    Y_adj <- d$SRS - (Z_hat - mean(Z_hat))
    pgc_fit <- lm(Y_adj ~ PFAS + fetal_sex, data = cbind(d, Y_adj))
    return(coef(pgc_fit)["PFAS"])
  }
  pgc_boot <- boot(df, pgc_fn, R = n_boot)
  pgc_ci <- tryCatch(boot.ci(pgc_boot, type = "perc"), error = function(e) NULL)

  results_list[[i]] <- list(
    lavaan_fit = lavaan_fit,
    COCA = list(
      estimate = psi_coca,
      boot = coca_boot,
      ci = coca_ci
    ),
    PGC = list(
      model = pgc_model,
      boot = pgc_boot,
      ci = pgc_ci
    )
  )
}
```

# Plotting

```{r plotting_results, warning = F, message = F}
# Extract SEM p-values
sem_pval_df <- data.frame(
  isoform = character(),
  path = character(),
  pval = numeric(),
  stringsAsFactors = FALSE
)

iso_names <- names(results_list)

# Initialize results data.frames
sem_pval_df <- data.frame()
coca_df <- data.frame()
pgc_df <- data.frame()

for (i in seq_along(results_list)) {
  iso <- iso_names[i]
  res <- results_list[[i]]

  # SEM path p-values
  fit <- res$lavaan_fit
  if (!is.null(fit)) {
    pe <- tryCatch(parameterEstimates(fit), error = function(e) NULL)
    if (!is.null(pe)) {
      selected_paths <- pe %>%
        filter(label %in% c("a1", "a3", "b1", "b3", "c",
                            "ind_female", "ind_male", "total_female", "total_male")) %>%
        select(label, pvalue)
      if (nrow(selected_paths) > 0) {
        sem_pval_df <- bind_rows(sem_pval_df,
                                 data.frame(
                                   isoform = iso,
                                   path = selected_paths$label,
                                   pval = selected_paths$pvalue
                                 ))
      }
    }
  }

  # COCA results
  coca_est <- res$COCA$estimate
  coca_ci <- res$COCA$ci
  if (!is.null(coca_est) && !is.null(coca_ci)) {
    ci <- coca_ci$percent[4:5]
    se <- (ci[2] - ci[1]) / (2 * 1.96)
    coca_pval <- 2 * pnorm(-abs(coca_est / se))
    signif <- !any(sign(ci) == c(-1, 1))
    coca_df <- bind_rows(coca_df, data.frame(
      isoform = iso,
      estimate = coca_est,
      ci_lower = ci[1],
      ci_upper = ci[2],
      pvalue = coca_pval,
      significant = signif
    ))
  }

  # PGC results
  pgc_model <- tryCatch(res$PGC$model, error = function(e) NULL)
  pgc_boot <- tryCatch(res$PGC$boot, error = function(e) NULL)

  if (!is.null(pgc_model) && !is.null(pgc_boot)) {
    pgc_est <- coef(pgc_model)["PFAS"]
    boot_estimates <- pgc_boot$t
    if (!is.null(boot_estimates) && length(boot_estimates) > 1) {
      ci_bounds <- quantile(boot_estimates, probs = c(0.025, 0.975), na.rm = TRUE)
      ci_lower <- ci_bounds[1]
      ci_upper <- ci_bounds[2]
      se <- sd(boot_estimates, na.rm = TRUE)
      pgc_pval <- 2 * pnorm(-abs(pgc_est / se))
      signif <- !(ci_lower < 0 & ci_upper > 0)

      pgc_df <- bind_rows(pgc_df, data.frame(
        isoform = iso,
        estimate = pgc_est,
        ci_lower = ci_lower,
        ci_upper = ci_upper,
        pvalue = pgc_pval,
        significant = signif
      ))
    }
  }
}
```

## SEM p-value distributions

```{r plot_sem_pvalues}
ggplot(sem_pval_df, aes(x = pval)) +
  geom_histogram(binwidth = 0.025, fill = "#4682B4", color = "black") +
  facet_wrap(~ path, scales = "free_y") +
  theme_minimal() +
  labs(title = "SEM Path p-values Across Isoforms",
       x = "p-value", y = "Frequency")
```

```{r sem_table, echo = F}
sem_table <- data.frame(
  Path = c("a1", "a3", "b1", "b3", "c", "ind_male", "ind_female", "total_male", "total_female"),
  Pattern = c(
    "Strong left skew",
    "Uniform / flat",
    "Strong left skew",
    "Uniform",
    "Strong left skew (many significant)",
    "Uniform to right-skewed",
    "U-shaped with weak left skew",
    "Strong left skew",
    "Strong left skew"
  ),
  Interpretation = c(
    "PFAS is robustly associated with imprinting disruption across many isoforms.",
    "No consistent fetal sex interaction on PFAS-to-expression path.",
    "Imprinting disruption is significantly associated with SRS in many isoforms.",
    "No consistent interaction effect between sex and expression on SRS.",
    "PFAS has a strong total effect on SRS in many isoforms, suggesting true mediation.",
    "Some male-specific mediation is detectable, but effects are diffuse.",
    "Female-specific mediation appears inconsistent or absent.",
    "Many isoforms show strong total PFAS -> SRS effects in males.",
    "Many isoforms show strong total PFAS -> SRS effects in females."
  )
)

kable(sem_table, caption = "Interpretation of SEM Path p-value Distributions")
```

## COCA & PGC p-value distributions

```{r plot_coca_pgc_pvals}
coca_pvals <- coca_df %>% mutate(Method = "COCA") %>% rename(pval = pvalue)
pgc_pvals <- pgc_df %>% mutate(Method = "PGC") %>% rename(pval = pvalue)

pval_df <- bind_rows(coca_pvals, pgc_pvals)

ggplot(pval_df, aes(x = pval)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "black") +
  facet_wrap(~ Method, scales = "free_y") +
  theme_minimal() +
  labs(title = "Raw p-values for COCA and PGC Tests",
       x = "p-value", y = "Number of Isoforms")
```

## COCA & PGC significance

```{r plot_significance_bar}
sig_df <- bind_rows(
  coca_df %>% select(isoform, significant) %>% mutate(Method = "COCA"),
  pgc_df %>% select(isoform, significant) %>% mutate(Method = "PGC")
) %>%
  mutate(Significance = ifelse(significant, "Significant", "Not Significant"))

ggplot(sig_df, aes(x = Method, fill = Significance)) +
  geom_bar(position = "dodge", color = "black") +
  scale_fill_manual(values = c("gray70", "forestgreen")) +
  theme_minimal() +
  labs(title = "CI-Based Significance of COCA and PGC Effects",
       x = "Method", y = "Number of Isoforms", fill = "Significance")
```

```{r interpret_NC_methods, echo = F}
coca_pgc_table <- data.frame(
  Method = c("COCA", "PGC"),
  PValue_Pattern = c(
    "Left-skewed with wide tail; suggestive but inconclusive",
    "Strong left skew (majority of p-values near 0)"
  ),
  CI_Significance = c(
    "0 isoforms significant (0%)",
    "97 isoforms significant (97%)"
  ),
  Interpretation = c(
    "COCA shows potential calibration but fails to cross significance thresholds, consistent with known instability in complex confounding settings where its assumptions may be violated.",
    "PGC detects nearly all true mediating isoforms, likely due to ideal proxy completeness in simulation. This aligns with literature noting PGC’s strong performance under idealized conditions but potential for failure when real confounders are incompletely captured."
  )
)

kable(coca_pgc_table, caption = "Summary of COCA and PGC Results for Isoform-Level Mediation")
```

# Regression adjustment models with control outcome variable as covariate

```{r, regression_adjustment_models}
# Example for one isoform
iso_idx <- 27
meth_proxy <- rowMeans(maternal_meth_list[[iso_idx]])

# Include sex main effect and interaction with expression
model <- lm(SRS ~ PFAS + expr_ratios[, iso_idx] * fetal_sex + meth_proxy)

summary(model)
```

```{r, loop_rgms_across_isoforms}
# Initialize results table for moderated direct adjustment
adjusted_lm_results <- data.frame(
  isoform = 1:n_isoforms,
  coef_expr = NA,
  p_expr = NA,
  coef_interaction = NA,
  p_interaction = NA,
  sig_ci_expr = NA,
  sig_ci_interaction = NA
)

for (i in 1:n_isoforms) {
  meth_proxy <- rowMeans(maternal_meth_list[[i]])
  
  # Fit interaction model
  fit <- lm(SRS ~ PFAS + expr_ratios[, i] * fetal_sex + meth_proxy)
  confint_fit <- confint(fit)
  coef_names <- names(coef(fit))
  
  # Extract coefficient and p-value for expr
  expr_term <- paste0("expr_ratios[, i]")
  int_term  <- paste0("expr_ratios[, i]:fetal_sex")
  
  if (expr_term %in% coef_names) {
    idx <- which(coef_names == expr_term)
    adjusted_lm_results$coef_expr[i] <- coef(fit)[idx]
    adjusted_lm_results$p_expr[i] <- summary(fit)$coefficients[idx, "Pr(>|t|)"]
    adjusted_lm_results$sig_ci_expr[i] <- !(0 >= confint_fit[idx, 1] & 0 <= confint_fit[idx, 2])
  }
  
  if (int_term %in% coef_names) {
    idx_int <- which(coef_names == int_term)
    adjusted_lm_results$coef_interaction[i] <- coef(fit)[idx_int]
    adjusted_lm_results$p_interaction[i] <- summary(fit)$coefficients[idx_int, "Pr(>|t|)"]
    adjusted_lm_results$sig_ci_interaction[i] <- !(0 >= confint_fit[idx_int, 1] & 0 <= confint_fit[idx_int, 2])
  }
}

# Plot: p-values for interaction terms
hist(adjusted_lm_results$p_interaction, breaks = 30,
     main = "Direct Adjustment: p-values for expr × sex → SRS",
     xlab = "p-value", col = "darkorange")

# Barplot: number of significant interaction effects
barplot(height = c(sum(adjusted_lm_results$sig_ci_interaction, na.rm = TRUE),
                   sum(!adjusted_lm_results$sig_ci_interaction, na.rm = TRUE)),
        names.arg = c("Significant", "Not Significant"),
        col = c("forestgreen", "gray70"),
        main = "Direct Adjustment: CI-Based Significance for Interaction",
        ylab = "Number of Isoforms")

direct_adj_table <- data.frame(
  Method = "Direct Adjustment (Huang, 2021)",
  PValue_Pattern = "Uniform (no enrichment near 0)",
  CI_Significance = "Few isoforms significant",
  Interpretation = "Adjusting directly for methylation removes most expression–SRS signal, suggesting either methylation absorbs the effect (overadjustment), or residual confounding remains. Consistent with Huang (2021), this approach is conservative but stable under real-data-like assumptions."
)

kable(direct_adj_table, caption = "Summary of Direct Adjustment Results (Huang, 2021 Approach)")
```
